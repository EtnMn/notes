<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Connection au remote backend depuis GitHub :: Notes</title>
    <link rel="canonical" href="https://menou.fr/notes/component-workshop-terraform/main/ci-cd/connect-remote-backend.html">
    <link rel="prev" href="../advanced-terraform/modules.html">
    <link rel="next" href="automate.html">
    <meta name="description" content="Connection au remote backend depuis GitHub.">
    <meta name="generator" content="Antora 3.1.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <img class="navbar-item" src="../../../_/img/logo.png" alt="logo" width="32" height="32">
      <a class="navbar-item" href="https://menou.fr/notes">Notes</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Rechercher">
        </div>
      </div>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/EtnMn">
          <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" aria-labelledby="title" aria-describedby="desc" role="img" xmlns:xlink="http://www.w3.org/1999/xlink">
              <title>My Github</title>
              <path data-name="layer2" d="M32 0a32.021 32.021 0 0 0-10.1 62.4c1.6.3 2.2-.7 2.2-1.5v-6c-8.9 1.9-10.8-3.8-10.8-3.8-1.5-3.7-3.6-4.7-3.6-4.7-2.9-2 .2-1.9.2-1.9 3.2.2 4.9 3.3 4.9 3.3 2.9 4.9 7.5 3.5 9.3 2.7a6.93 6.93 0 0 1 2-4.3c-7.1-.8-14.6-3.6-14.6-15.8a12.27 12.27 0 0 1 3.3-8.6 11.965 11.965 0 0 1 .3-8.5s2.7-.9 8.8 3.3a30.873 30.873 0 0 1 8-1.1 30.292 30.292 0 0 1 8 1.1c6.1-4.1 8.8-3.3 8.8-3.3a11.965 11.965 0 0 1 .3 8.5 12.1 12.1 0 0 1 3.3 8.6c0 12.3-7.5 15-14.6 15.8a7.746 7.746 0 0 1 2.2 5.9v8.8c0 .9.6 1.8 2.2 1.5A32.021 32.021 0 0 0 32 0z" fill="#FFF"></path>
              <path data-name="layer1" d="M12.1 45.9c-.1.2-.3.2-.5.1s-.4-.3-.3-.5.3-.2.6-.1c.2.2.3.4.2.5zm1.3 1.5a.589.589 0 0 1-.8-.8.631.631 0 0 1 .7.1.494.494 0 0 1 .1.7zm1.3 1.8a.585.585 0 0 1-.7-.3.6.6 0 0 1 0-.8.585.585 0 0 1 .7.3c.2.3.2.7 0 .8zm1.7 1.8c-.2.2-.5.1-.8-.1-.3-.3-.4-.6-.2-.8a.619.619 0 0 1 .8.1.554.554 0 0 1 .2.8zm2.4 1c-.1.3-.4.4-.8.3s-.6-.4-.5-.7.4-.4.8-.3c.3.2.6.5.5.7zm2.6.2c0 .3-.3.5-.7.5s-.7-.2-.7-.5.3-.5.7-.5c.4.1.7.3.7.5zm2.4-.4q0 .45-.6.6a.691.691 0 0 1-.8-.3q0-.45.6-.6c.5-.1.8.1.8.3z" fill="#FFF"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="component-workshop-terraform" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../terraform-intro.html">Workshop Terraform</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../terraform-intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../setup.html">Mise en place</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../create-resources.html">Créer des ressources</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced-terraform/backend.html">Backend</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced-terraform/existing-resources.html">Ressources existantes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced-terraform/modules.html">Les modules</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="connect-remote-backend.html">Connecter GitHub au backend</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="automate.html">Automatiser</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Workshop Terraform</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../terraform-intro.html">Workshop Terraform</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../terraform-intro.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../terraform-intro.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../terraform-intro.html">Workshop Terraform</a></li>
    <li><a href="connect-remote-backend.html">Connecter GitHub au backend</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/EtnMn/workshop-terraform/edit/main/docs/modules/ci-cd/pages/connect-remote-backend.adoc">Éditer</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Connection au remote backend depuis GitHub</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Les fichiers <a href="../terraform-intro.html#state" class="xref page">states</a> permettent de déterminer les modifications à apporter à une infrastructure en comparant la configuration <em>Terraform</em> à l&#8217;existant. Le <a href="../advanced-terraform/backend.html#azurerm" class="xref page">backend  Azurerm</a> permet de stocker les fichiers <em>states</em> dans un <em>Azure storage</em>, dont L'<strong>authentification</strong> peut être réalisée de <a href="https://www.terraform.io/language/settings/backends/azurerm#example-configuration">différentes manières</a> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure CLI</p>
</li>
<li>
<p>Service Principal</p>
</li>
<li>
<p>Azure AD</p>
</li>
<li>
<p>OIDC</p>
</li>
<li>
<p>SAS Token</p>
</li>
<li>
<p>MSI (Managed security identity)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="shared-access-signature-sas-tokens"><a class="anchor" href="#shared-access-signature-sas-tokens"></a>Shared Access Signature (SAS) Tokens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les <em>SAS tokens</em> permettent de déléguer l&#8217;accès au <em>storage account</em>, au conteneur ou même à un <em>blob</em>, tout en permettant un contrôle poussé de l&#8217;accès (durée, filtrage d'<em>IP</em>&#8230;&#8203;). Il impose par contre de gérer le renouvellement du jeton et ainsi que sa sécurité. Pour ce dernier point, <em>Terraform</em> recommande d&#8217;utiliser la <a href="https://www.terraform.io/language/settings/backends/configuration#partial-configuration">configuration partielle</a> du backend et de définir le <em>SAS token</em> dans les <a href="https://www.terraform.io/language/settings/backends/azurerm#configuration-variables">variables d&#8217;environnement</a>: <code>ARM_SAS_TOKEN</code>.</p>
</div>
<div class="listingblock">
<div class="title">Générer le SAS token pour le conteneur</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">END_DATE=$(date -u -d "+2 years" +%Y-%m-%dT%H:%MZ) <i class="conum" data-value="1"></i><b>(1)</b>
ARM_SAS_TOKEN=$(az storage container generate-sas -n $CONTAINER_NAME --account-key $ACCOUNT_KEY --account-name $TF_STORAGE_ACCOUNT --https-only --permissions dlrw --expiry $END_DATE -o tsv)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Période de validité de 2 ans</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dans le <em>repo GitHub</em> du projet, aller dans <span class="menuseq"><b class="menu">Settings</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Secrets</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">Actions</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">New Repository Secret</b></span> pour ajouter un nouveau secret nommé <code>ARM_SAS_TOKEN</code> et ayant pour valeur, le token généré.</p>
</div>
<div class="paragraph">
<p>Créer ensuite un nouveau <a href="https://docs.github.com/en/actions/using-workflows/about-workflows"><em>workflow GitHub</em></a> :</p>
</div>
<div class="listingblock">
<div class="title">terraform.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml hljs" data-lang="yml">name: 'Terraform'

on:
  push:
    branches:
    - main
  pull_request:
  workflow_dispatch:

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production
    env:
      ARM_SAS_TOKEN: ${{ secrets.ARM_SAS_TOKEN }}

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3

    # Install the needed version of Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.2.1

    - name: Terraform Init
      run: terraform init</code></pre>
</div>
</div>
<div class="paragraph">
<p>Après exécution du <em>workflow</em>, le <em>state</em> doit être présent dans le conteneur.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="service-principal"><a class="anchor" href="#service-principal"></a>Service Principal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un <em>service principal</em> est une identité utilisée par les applications pour accéder aux ressources <em>Azure</em>. Cet accès est limité par les rôles (<em>RBAC</em>), ce qui permet de contrôler l&#8217;accessibilité aux ressources. Lorsque l&#8217;on <a href="https://docs.microsoft.com/fr-fr/cli/azure/create-an-azure-service-principal-azure-cli">crée</a> un <em>service principal</em>, on obtient les informations d&#8217;identification.</p>
</div>
<div class="literalblock">
<div class="title">Création du <em>service principal</em></div>
<div class="content">
<pre>$ az ad sp create-for-rbac --name="SP_NAME" --role="Contributor" --scopes="/subscriptions/SUBSCRIPTION_ID"</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sortie incluant les secrets à protéger</div>
<div class="content">
<pre>{
  "appId": "00000000-0000-0000-0000-000000000000",
  "displayName": "SP_NAME",
  "password": "0000-0000-0000-0000-000000000000",
  "tenant": "0000-0000-0000-0000-000000000000"
}</pre>
</div>
</div>
<div class="paragraph">
<p>Il est possible de renseigner ces identifiants de <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_client_secret#configuring-the-service-principal-in-terraform">différentes manières</a> dans <em>Terraform</em>, mais il est recommandé d&#8217;utiliser les variables d&#8217;environnement. Dans  <em>GitHub</em>, ajouter les secrets suivants :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ARM_CLIENT_ID="00000000-0000-0000-0000-000000000000"
ARM_CLIENT_SECRET="00000000-0000-0000-0000-000000000000"
ARM_SUBSCRIPTION_ID="00000000-0000-0000-0000-000000000000"
ARM_TENANT_ID="00000000-0000-0000-0000-000000000000"</pre>
</div>
</div>
<div class="paragraph">
<p>Le workflow est ensuite modifié pour inclure ces valeurs :</p>
</div>
<div class="listingblock">
<div class="title">terraform.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml hljs" data-lang="yml">name: 'Terraform'

on:
  push:
    branches:
    - main
  pull_request:
  workflow_dispatch:

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: production
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3

    # Install the needed version of Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.2.1

    - name: Terraform Init
      run: terraform init</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-ad"><a class="anchor" href="#azure-ad"></a>Azure AD</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La configuration de l&#8217;authentification <em>Azure AD</em> est assez proche de celle utilisant le <em>service principal</em>, sauf qu&#8217;elle n&#8217;utilise pas les <em>access keys</em> mais l'<em>AD</em> pour se connecter au <em>backend</em>.</p>
</div>
<div class="listingblock">
<div class="title">main.tf</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-terraform hljs" data-lang="terraform">  backend "azurerm" {
    storage_account_name = "ststate18465"
    container_name       = "tfstate"
    key                  = "terraform.tfstate"
    use_azuread_auth     = true <i class="conum" data-value="1"></i><b>(1)</b>
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Impose l&#8217;authentification <em>Azure AD</em> pour accéder au <em>blob storage account</em></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A la place de la propriété <code>use_azuread_auth</code>, il est aussi possible de définir la variable d&#8217;environnement <code>ARM_USE_AZUREAD</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;utilisation de l&#8217;authentification <em>Azure AD</em> nécessite d&#8217;assigner le rôle <code>Storage Blob Data Owner</code> au <em>service principal</em> dans le <em>storage</em>. Dans le cas contraire, on obtient l&#8217;erreur suivante :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>StatusCode=403 -- Original Error: autorest/azure: Service returned an error. Status=403 Code="AuthorizationPermissionMismatch" Message="This request is not authorized to perform this operation using this permission.</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Assignation du rôle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az role assignment create \
  --role "Storage Blob Data Owner" \
  --assignee 00000000-0000-0000-0000-000000000000 \
  --scope "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/$RESOURCE_GROUP_NAME/providers/Microsoft.Storage/storageAccounts/$TF_STORAGE_ACCOUNT/blobServices/default/containers/$CONTAINER_NAME"</code></pre>
</div>
</div>
<div class="paragraph">
<p>La commande suivante permet de lister les particularités du rôle.</p>
</div>
<div class="listingblock">
<div class="title">Afficher les permissions du rôle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">az role definition list \
  --name "Storage Blob Data Owner" \
  --output json \
  --query '[].{actions:permissions[0].actions, notActions:permissions[0].notActions}'</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La propagation du rôle peut prendre plusieurs minutes avant d&#8217;être effective.</p>
</div>
<div class="paragraph">
<p>Lors du développement, les utilisateurs doivent également posséder ce rôle pour se connecter au conteneur. C&#8217;est un bon moyen pour protéger l&#8217;accès, mais cela peut être fastidieux à configurer. Il reste possible d&#8217;utiliser la <a href="https://www.terraform.io/language/settings/backends/configuration#partial-configuration">configuration partielle</a> et un <em>SAS token</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../advanced-terraform/modules.html">Les modules</a></span>
  <span class="next"><a href="automate.html">Automatiser</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
